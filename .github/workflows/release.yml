name: Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create packages
      run: |
        chmod +x package.sh
        ./package.sh ${{ steps.version.outputs.VERSION }}
    
    - name: Create Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh release create ${{ steps.version.outputs.VERSION }} \
          dist/*.tar.gz \
          --title "${{ steps.version.outputs.VERSION }}" \
          --notes "Release ${{ steps.version.outputs.VERSION }}

        ## Installation

        ### Using bin
        \`\`\`bash
        bin install github.com/joshuascottpaul/markdown-to-audio
        \`\`\`

        ### Using ubi
        \`\`\`bash
        ubi --project joshuascottpaul/markdown-to-audio --in ~/.local/bin
        \`\`\`

        ### Manual
        \`\`\`bash
        # Download for your platform
        curl -L https://github.com/joshuascottpaul/markdown-to-audio/releases/download/${{ steps.version.outputs.VERSION }}/markdown-to-audio-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz | tar xz
        cd markdown-to-audio-linux-amd64
        ./install.sh
        \`\`\`

        ## Requirements
        - Python 3.7+
        - ffmpeg
        - OpenAI API key

        See [README.md](https://github.com/joshuascottpaul/markdown-to-audio#readme) for full documentation."
